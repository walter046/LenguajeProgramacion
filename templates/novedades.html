{% extends 'app.html' %}
{% block title %}Novedades{% endblock %}

{% block customCSS %}
<style>
  .zapatilla {
    border: 1px solid #ccc;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 5px;
  }
  h2 {
    color: #333;
  }
  .precio {
    font-size: 1.2em;
    color: #007bff;
  }
</style>
{% endblock %}

{% block content %}
<div
  id="mini-cart"
  class="fixed top-20 right-4 bg-white rounded-lg shadow-xl z-50 w-80 max-h-[70vh] overflow-y-auto hidden border border-gray-200"
>
  <div class="p-4 border-b border-gray-200">
    <h3
      class="text-lg font-bold text-gray-800 flex items-center justify-between"
    >
      <span>Mi Carrito</span>
      <button id="close-cart" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times"></i>
      </button>
    </h3>
  </div>
  <div id="cart-items" class="divide-y divide-gray-200">
    <!-- Los items del carrito se agregarán aquí dinámicamente -->
    <div class="p-4 text-center text-gray-500">
      <i class="fas fa-shopping-cart text-3xl mb-2"></i>
      <p>Tu carrito está vacío</p>
    </div>
  </div>
  <div class="p-4 border-t border-gray-200 bg-gray-50">
    <div class="flex justify-between mb-4">
      <span class="font-bold">Total:</span>
      <span id="cart-total" class="font-bold">S/ 0.00</span>
    </div>
    <a
      href="{{ url_for('main.carrito') }}"
      class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center py-2 rounded-lg transition-colors btn-primary"
    >
      Finalizar Compra
    </a>
  </div>
</div>

<div id="notification-container" class="fixed bottom-4 right-4 z-[100] space-y-2 w-full max-w-xs"></div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">Catálogo de Zapatillas</h1>
  
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {% for zapatilla in zapatillas %}
<div class="zapatilla bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300">
  <div class="relative h-48 bg-gray-100 flex items-center justify-center overflow-hidden">
    {% if zapatilla.imagen %}
      <img 
        src="{{ zapatilla.imagen }}" 
        alt="{{ zapatilla.nombre_zapatilla }}"
        class="w-full h-full object-contain p-4 transition-transform duration-300 hover:scale-105"
        onerror="this.src='{{ url_for('static', filename='img/usuario.png') }}'"
        loading="lazy"
        onload="this.style.opacity='1'"
        style="opacity: 0;"
      >
      <div class="absolute inset-0 flex items-center justify-center bg-gray-100" id="spinner-{{ zapatilla.id_zapatilla }}">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    {% else %}
      <div class="flex items-center justify-center h-full">
        <i class="fas fa-shoe-prints text-4xl text-gray-400"></i>
      </div>
    {% endif %}
  </div>
  
  <div class="p-6">
    <h2 class="text-xl font-bold text-gray-800 mb-2">{{ zapatilla.nombre_zapatilla }}</h2>
    <p class="text-sm text-gray-600 mb-2"><strong>Marca:</strong> {{ zapatilla.nombre_marca }}</p>
    <p class="text-sm text-gray-700 mb-4">{{ zapatilla.descripcion }}</p>
    <p class="precio text-center text-2xl font-bold text-blue-600 mb-4">
      ${{ zapatilla.precio }}
    </p>
    
    <div class="flex space-x-2">
      <a href="#" class="flex-1 text-center text-blue-600 hover:text-blue-800 font-medium transition-colors">
        Ver Detalles
      </a>
      <button
        class="add-to-cart-btn flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-md flex items-center justify-center space-x-2 transition-all"
        data-id="{{ zapatilla.id_zapatilla }}"
        data-nombre="{{ zapatilla.nombre_zapatilla }}"
        data-precio="{{ zapatilla.precio }}"
        onclick="console.log('Botón clickeado - ID: {{ zapatilla.id_zapatilla }}, Nombre: {{ zapatilla.nombre_zapatilla }}, Precio: {{ zapatilla.precio }}')"
      >
        <span>Añadir al carrito</span>
        <i class="fas fa-shopping-cart"></i>
      </button>
    </div>
  </div>
</div>
    {% endfor %}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM cargado, inicializando carrito...");
    
    function handleImageLoad() {
      const images = document.querySelectorAll('img[loading="lazy"]');
      images.forEach(img => {
        img.addEventListener('load', function() {
          const spinnerId = 'spinner-' + this.closest('.zapatilla').querySelector('[data-id]').getAttribute('data-id');
          const spinner = document.getElementById(spinnerId);
          if (spinner) {
            spinner.style.display = 'none';
          }
        });
        
        img.addEventListener('error', function() {
          const spinnerId = 'spinner-' + this.closest('.zapatilla').querySelector('[data-id]').getAttribute('data-id');
          const spinner = document.getElementById(spinnerId);
          if (spinner) {
            spinner.style.display = 'none';
          }
        });
      });
    }
    
    handleImageLoad();
    
    const miniCart = document.getElementById("mini-cart");
    const cartToggle = document.getElementById("cart-toggle");
    const closeCartBtn = document.getElementById("close-cart");
    const cartCountSpan = document.getElementById("cart-count");
    const cartItemsContainer = document.getElementById("cart-items");
    const cartTotalSpan = document.getElementById("cart-total");
    
    console.log("Elementos del carrito encontrados:", {
      miniCart: !!miniCart,
      cartToggle: !!cartToggle,
      cartCountSpan: !!cartCountSpan,
      cartItemsContainer: !!cartItemsContainer
    });

    function showNotification(message, type = "info") {
      const container = document.getElementById("notification-container");
      if (!container) {
        const newContainer = document.createElement("div");
        newContainer.id = "notification-container";
        newContainer.className =
          "fixed bottom-4 right-4 z-[100] space-y-2 w-full max-w-xs";
        document.body.appendChild(newContainer);
      }

      const notification = document.createElement("div");
      notification.className = `notification p-4 rounded-lg shadow-lg border-l-4 transition-all duration-300 transform translate-x-full opacity-0 ${getNotificationStyles(
        type
      )}`;
      notification.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0">${getNotificationIcon(
                      type
                    )}</div>
                    <div class="ml-3 flex-1"><p class="text-sm font-medium">${message}</p></div>
                    <div class="ml-3 flex-shrink-0">
                        <button onclick="this.parentElement.parentElement.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => this.parentElement.parentElement.remove(), 300);" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>`;
      document
        .getElementById("notification-container")
        .appendChild(notification);
      setTimeout(() => {
        notification.classList.remove("translate-x-full", "opacity-0");
      }, 50);
      setTimeout(() => {
        notification.classList.add("translate-x-full", "opacity-0");
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    function getNotificationStyles(type) {
      const styles = {
        success: "bg-green-50 border-green-400 text-green-800",
        error: "bg-red-50 border-red-400 text-red-800",
        info: "bg-blue-50 border-blue-400 text-blue-800",
      };
      return styles[type] || styles["info"];
    }

    function getNotificationIcon(type) {
      const icons = {
        success:
          '<svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>',
        error:
          '<svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>',
        info: '<svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>',
      };
      return icons[type] || icons["info"];
    }

    async function renderCartItems() {
      try {
        const response = await fetch("/get_cart");
        const data = await response.json();
        const cart = data.cart;

        let total = 0;
        let totalItemsCount = 0;
        cartItemsContainer.innerHTML = "";

        if (Object.keys(cart).length === 0) {
          cartItemsContainer.innerHTML = `
                        <div class="p-4 text-center text-gray-500">
                            <i class="fas fa-shopping-cart text-3xl mb-2"></i>
                            <p>Tu carrito está vacío</p>
                        </div>
                    `;
        } else {
          for (const id in cart) {
            const item = cart[id];
            total += item.precio * item.cantidad;
            totalItemsCount += item.cantidad;

            const itemHTML = `
                            <div class="cart-item p-4 flex items-start">
                                <img src="${
                                  item.imagen ||
                                  "https://via.placeholder.com/64"
                                }" alt="${
              item.nombre
            }" class="w-16 h-16 object-cover rounded">
                                <div class="ml-3 flex-grow">
                                    <h4 class="font-medium text-gray-900">${
                                      item.nombre
                                    }</h4>
                                    <p class="text-sm text-gray-600">S/ ${item.precio.toFixed(
                                      2
                                    )}</p>
                                    <div class="flex items-center mt-1">
                                        <button class="change-quantity text-gray-500 hover:text-blue-600" data-id="${id}" data-change="-1">
                                            <i class="fas fa-minus text-xs"></i>
                                        </button>
                                        <span class="mx-2 text-gray-700">${
                                          item.cantidad
                                        }</span>
                                        <button class="change-quantity text-gray-500 hover:text-blue-600" data-id="${id}" data-change="1">
                                            <i class="fas fa-plus text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                                <button class="remove-item text-gray-400 hover:text-red-500 ml-2" data-id="${id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
            cartItemsContainer.innerHTML += itemHTML;
          }
        }

        cartTotalSpan.textContent = `S/ ${total.toFixed(2)}`;
        cartCountSpan.textContent = totalItemsCount;

        // Añadir event listeners para botones de cantidad y eliminar
        document.querySelectorAll(".change-quantity").forEach((button) => {
          button.addEventListener("click", async function () {
            const id = this.getAttribute("data-id");
            const change = parseInt(this.getAttribute("data-change"));
            await updateCartItem(id, change);
          });
        });

        document.querySelectorAll(".remove-item").forEach((button) => {
          button.addEventListener("click", async function () {
            const id = this.getAttribute("data-id");
            // Para eliminar, pasamos una cantidad negativa igual a la cantidad actual
            const item = cart[id];
            if (item) {
              await updateCartItem(id, -item.cantidad);
            }
          });
        });
      } catch (error) {
        console.error("Error al obtener el carrito:", error);
        showNotification(
          "Error al cargar el carrito. Inténtelo de nuevo.",
          "error"
        );
      }
    }

    async function updateCartItem(id, change) {
      try {
        const response = await fetch("/update_cart_item", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: id, change: change }),
        });
        const result = await response.json();
        if (response.ok && result.success) {
          renderCartItems();
          showNotification(result.message, "success");
        } else {
          showNotification(
            result.message || "Error al actualizar el carrito.",
            "error"
          );
        }
      } catch (error) {
        console.error("Error al actualizar el item del carrito:", error);
        showNotification(
          "Error de conexión al actualizar el carrito.",
          "error"
        );
      }
    }

    const addToCartButtons = document.querySelectorAll(".add-to-cart-btn");
    console.log("Botones de añadir al carrito encontrados:", addToCartButtons.length);
    
    addToCartButtons.forEach((button) => {
      button.addEventListener("click", async function () {
        console.log("Botón de añadir al carrito clickeado");
        
        const zapatilla = {
          id: this.dataset.id,
          nombre: this.dataset.nombre,
          precio: parseFloat(this.dataset.precio),
        };

        console.log("Datos de la zapatilla:", zapatilla);

        try {
          const response = await fetch("/agregarCarrito", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(zapatilla),
          });
          
          console.log("Respuesta del servidor:", response.status);
          const data = await response.json();
          console.log("Datos de respuesta:", data);

          if (response.ok && data.success) {
            showNotification(data.message, "success");
            renderCartItems();
            miniCart.classList.remove("hidden");
          } else {
            showNotification(
              data.message || "Error al añadir el producto al carrito.",
              "error"
            );
          }
        } catch (error) {
          console.error("Error al añadir al carrito:", error);
          showNotification("Error de conexión al añadir al carrito.", "error");
        }
      });
    });

    cartToggle.addEventListener("click", function (e) {
      e.stopPropagation();
      miniCart.classList.toggle("hidden");
      if (!miniCart.classList.contains("hidden")) {
        renderCartItems();
      }
    });

    closeCartBtn.addEventListener("click", function () {
      miniCart.classList.add("hidden");
    });

    document.addEventListener("click", function (e) {
      if (
        !miniCart.contains(e.target) &&
        e.target !== cartToggle &&
        !cartToggle.contains(e.target)
      ) {
        miniCart.classList.add("hidden");
      }
    });

    renderCartItems();
    console.log("Script de carrito inicializado completamente");
  });
</script>

{% endblock %}
